{
    "id": "survey_666",
    "title": "Enqu√™te Questionnaire",
    "title_app": "Enqu√™te Questionnaire_ARP",
    "version": "1.0",
    "mode_enqueteur": "Enqueteur",
    "description": "Collecte des informations sur les transports",
    "steps": [
      {
        "id": "q1",
        "title": "Q1.",
        "type": "text",
        "label": "Quel est votre moyen de transport principal ?",
        "placeholder": "Ex : Bus, Train, Voiture...",
        "help_text": "Indiquez le moyen que vous utilisez le plus souvent",
        "redirection": "q13",
        "input_cond": "",
        "output_cond": "value.length > 0",
        "required": true,
        "isSubQuestion": false,
        "page": 1
      },
      {
        "id": "q13",
        "type": "gridB",
        "title": "Q13.",
        "label": "Activit√©s pratiqu√©es et motivation principale du s√©jour",
        "required": true,
        "redirection": "q14",
        "rows": [
          { "id": "walk", "label": "Se promener, fl√¢ner" },
          { "id": "museum", "label": "Visites de mus√©es, monuments" },
          { "id": "nature", "label": "Parcs, jardins, sites naturels" },
          { "id": "guided", "label": "Visites guid√©es de quartiers" }
        ],
      
        "columns": [
          {
            "id": "activity",
            "label": "Activit√©s pratiqu√©es",
            "input": {
              "type": "checkbox",
              "axis": "column",
              "validation": {
                "min": 1
              }
            }
          },
          {
            "id": "reason",
            "label": "Motivation principale du s√©jour",
            "input": {
              "type": "radio",
              "axis": "column",
              "validation": {
                "required": true,
                "max": 1
              }
            }
          }
        ]
      }
  ,    
  {
    "id": "q14",
    "type": "gridB",
    "title": "Q14.",
    "label": "√Ä quelle fr√©quence utilisez-vous les moyens de transport suivants ?",
    "required": true,
  "redirection": "q15",
    "rows": [
          { "id": "bus", "label": "Bus" },
          { "id": "train", "label": "Train" },
          { "id": "metro", "label": "M√©tro" }
        ],
  
    "columns": [
      {
        "id": "daily",
        "label": "Tous les jours",
        "input": {
          "type": "checkbox",
          "axis": "row",
          "validation": {
            "min": 1
          }
        }
      },
      {
        "id": "weekly",
        "label": "Quelques fois par semaine",
        "input": {
          "type": "checkbox",
          "axis": "row",
          "validation": {
            "required": true,
            "min": 1
          }
        }
      },
      {
        "id": "rarely",
        "label": "Rarement",
        "input": {
          "type": "checkbox",
          "axis": "row",
          "validation": {
            "required": true,
            "min": 1
          }
        }
      }
    ]
  }
  ,    
  {
    "id": "q15",
    "type": "gridB",
    "title": "Q15.",
    "label": "Quels services utilisez-vous dans votre ville ? (plusieurs r√©ponses possibles)",
    "required": true,
  "rows": [
          { "id": "transport", "label": "Transports en commun" },
          { "id": "parking", "label": "Parking public" },
          { "id": "velib", "label": "V√©los en libre-service" }
        ],
  
    "columns": [
      {
        "id": "yes",
        "label": "oui",
        "input": {
          "type": "radio",
          "axis": "row",
          "validation": {
            "min": 1
          }
        }
      },
      {
        "id": "no",
        "label": "Non",
        "input": {
          "type": "radio",
          "axis": "row",
          "validation": {
            "required": true,
            "min": 1
          }
        }
      }
    ]
  }
  ,    
      {
        "id": "q33",
        "type": "accordion",
        "title": "Q33.",
        "label": "Informations compl√©mentaires sur vos transports",
        "page": 4,
        "required": true,
        "redirection": "q2",
      
        "sections": [
          {
            "id": "section_bus",
            "title": "Bus",
            "questions": [
              {
                "id": "q10_1",
                "type": "single_choice",
                "label": "Utilisez-vous le bus ?",
                "required": true,
                "options": [
                  { "codeItem": 1, "label": "Oui" , "requiresPrecision": true},
                  { "codeItem": 2, "label": "Non" }
                ]
              },
              {
                "id": "q10_2",
                "type": "text",
                "label": "Quelle ligne utilisez-vous ?",
                "required": false
              }
            ]
          },
          {
            "id": "section_Pays U.E",
            "title": "Pays U.E",
            "questions": [
              {
                "id": "q10_3",
                "type": "multiple_choice",
                "label": "",
                "required": true,
                "options": [
                  { "codeItem": 1, "value": "France", "label": "France"},
                  { "codeItem": 2, "value": "Allemagne", "label": "Allemagne"},
                  { "codeItem": 3, "value": "Royaume-Uni", "label": "Royaume-Uni"},
                  { "codeItem": 4, "value": "Belgique", "label": "Belgique"}
                ]
              }
            ]
          },
      
          {
            "id": "section_train",
            "title": "Train",
            "questions": [
              {
                "id": "q10_4",
                "type": "spinner",
                "label": "Fr√©quence d‚Äôutilisation",
                "options": ["","Tous les jours", "Hebdomadaire", "Rarement"],
                "required": true
              }
            ]
          }
        ]
      },
      
      
      {
        "id": "q2",
        "title": "Q2.",
        "type": "single_choice",
        "label": "Fr√©quence d‚Äôutilisation du transport en commun",
        "page": 2,
        "input_cond": "",
        "output_cond": "value.length > 0",
        "options": [
          {
            "codeItem": 1,
            "label": "Tous les jours"
          },
          {
            "codeItem": 2,
            "label": "Quelques fois par semaine"
          },
          {
            "codeItem": 5,
            "label": "Autre",
            "requiresPrecision": true
          }
        ],
        "placeholder": "",
        "help_text": "S√©lectionnez la fr√©quence la plus proche de votre utilisation",
        "redirection": "q3",
        "required": true,
        "isSubQuestion": false,
        "navigation": {
          "rules": [
            {
              "if": { "operator": "NOT_EQUALS",
              "field": "codeItem",
               "value":2},
              "then": { "goTo": "q6" }
            }
          ],
          "default": "redirection"
        }
      },
      {
        "id": "q12",
        "type": "gridA",
        "title": "Q12.",
        "label": "Activit√©s pratiqu√©es et motivation principale du s√©jour",
        "required": true,
           "redirection": "q22",
      
        "rows": [
          { "id": "walk", "label": "Se promener, fl√¢ner" },
          { "id": "museum", "label": "Visites de mus√©es, monuments" },
          { "id": "nature", "label": "Parcs, jardins, sites naturels" },
          { "id": "guided", "label": "Visites guid√©es de quartiers" }
        ],
      
        "columns": [
          {
            "id": "activity",
            "label": "Activit√©s pratiqu√©es",
            "type": "multiple_choice"
           
          },
          {
            "id": "reason",
            "label": "Motivation principale du s√©jour",
            "type": "single_choice"
           
          }
        ],
      
        "rules": {
          "atLeastOneActivity": true,
          "oneMainReason": true
        }
      }
  ,    
  
      {
        "id": "q20",
        "type": "grid",
        "title": "Q20.",
        "label": "√Ä quelle fr√©quence utilisez-vous les moyens de transport suivants ?",
        "redirection": "q22",
        "required": true,
        "page": 2,
        "rows": [
          { "id": "bus", "label": "Bus" },
          { "id": "train", "label": "Train" },
          { "id": "metro", "label": "M√©tro" }
        ],
        "columns": [
          { "value": "daily", "label": "Tous les jours" },
          { "value": "weekly", "label": "Quelques fois par semaine" },
          { "value": "rarely", "label": "Rarement" },
          { "value": "never", "label": "Jamais", "exclusive": true }
        ],
        "rules": {
          "onePerRow": false,
          "requiredRows": ["bus", "train"]
        }
      },
      {
        "id": "q22",
        "type": "grid",
        "title": "Q22.",
        "label": "Quels services utilisez-vous dans votre ville ? (plusieurs r√©ponses possibles)",
        "required": true,
        "redirection": "q2",
        "page": 3,
        "rows": [
          { "id": "transport", "label": "Transports en commun" },
          { "id": "parking", "label": "Parking public" },
          { "id": "velib", "label": "V√©los en libre-service" }
        ],
        "columns": [
          { "value": "yes", 
          "label": "Oui" },
          { "value": "no", "label": "Non" }
        ],
        "rules": {
          "onePerRow": true,
          "requiredRows": ["transport"]
        }
      },
      
      {
        "id": "q3",
        "title": "Q3.",
        "type": "multiple_choice",
        "label": "Quels transports utilisez-vous ?",
        "page": 5,
        "options": [
          {
            "codeItem": 1,
            "value": "Bus",
            "label": "Bus",
            "requiresSubQst": {
              "id": "q6",
              "type": "spinner",
              "label": "Choisissez votre r√©gion",
              "options": ["Nord", "Sud", "Est", "Ouest", "Centre"],
              "subQuestions": [
                {
                  "id": "q6a",
                  "type": "text",
                  "label": "Pourquoi cette r√©gion ?"
                }
              ]
            }
          },
          {
            "codeItem": 2,
            "value": "Train",
            "label": "Train",
            "requiresPrecision": true
          },
          {
            "codeItem": 3,
            "value": "Voiture",
            "label": "Voiture",
            "requiresSubQst": {
              "value": true,
              "subQst_id": "q10"
            }
          },
          {
            "codeItem": 4,
            "value": "V√©lo",
            "label": "V√©lo"
          },
          {
            "codeItem": 5,
            "value": "Marche",
            "label": "Marche"
          },
          {
            "codeItem": 6,
            "value": "Aucun",
            "label": "Aucun",
            "exclusive": true
          }
        ],
        "required": true,
        "output_cond": "value.length > 0",
        "redirection": "q4",
        "isSubQuestion": false,
        "navigation": {
      "rules": [
        {
          "if": { "operator": "EQUALS",
          "field": "codeItem",
           "value":5},
          "then": { "goTo": "q6" }
        }
      ],
      "default": "redirection"
    }
      },
      {
        "id": "q4",
        "title": "Q4.",
        "type": "autocomplete",
        "label": "Votre commune de r√©sidence",
        "page": 6,
        "table": "communes",
        "columns": [
          { "name": "commune", "displayInList": true, "displayInInput": true, "saveInDB": true },
          { "name": "cp", "displayInList": true, "displayInInput": false, "saveInDB": false },
          { "name": "_id", "displayInList": false, "displayInInput": false, "saveInDB": true }
        ],
        "placeholder": "Tapez pour rechercher votre commune",
        "help_text": "Commencez √† taper et s√©lectionnez la commune correspondante",
        "redirection": "FIN",
        "input_cond": "",
        "output_cond": "value !== null",
        "required": true,
        "isSubQuestion": false,
        "navigation": {
    "rules": [
      {
        "if": {
          "operator": "IN",
          "field": "commune",
          "values": ["Kouba", "Alger Centre"]
        },
        "then": { "goTo": "q14" }
      }
    ],
    "default": "redirection"
  }
  
      },
      {
        "id": "q5",
        "title": "Q5.",
        "type": "spinner",
        "label": "Choisissez votre r√©gion",
        "page": 7,
        "options": ["Sud", "Est", "Ouest", "Centre"],
        "placeholder": "S√©lectionnez une option",
        "required": true,
        "redirection": "q2",
        "isSubQuestion": false,
         "navigation": {
      "rules": [
        {
          "if": { "operator": "IN", "values": ["Sud", "Ouest"] },
          "then": { "goTo": "q3" }
        }
      ],
      "default": "redirection"
    }
  },
      {
        "id": "q14",
        "title": "Q14.",
        "type": "spinner",
        "label": "Choisissez votre r√©gion",
        "page": 8,
        "options": ["Est", "Ouest", "Centre"],
        "placeholder": "S√©lectionnez une option",
        "required": true,
        "redirection": "FIN",
        "isSubQuestion": false
      },
     
      {
        "id": "q7",
        "title": "Q7bis.",
        "type": "spinner",
        "label": "Choisissez votre r√©gion",
        "options": ["Nord22", "Sud35", "Est5", "Ouest8", "Centre87"],
        "placeholder": "S√©lectionnez une option",
        "required": true,
        "isSubQuestion": true
      },
      {
        "id": "q6",
        "title": "Q6bis.",
        "type": "text",
        "label": "Quel est votre moyen de transport principal  bus?",
        "placeholder": "uu",
        "help_text": "Indiquez le moyen que vous utilisez le plus souvent",
        "input_cond": "",
        "output_cond": "value.length > 0",
        "required": true,
        "isSubQuestion": true
      },
      {
        "id": "q8",
        "title": "Q8bis.",
        "type": "multiple_choice",
        "label": "Quels transports utilisez-vous ?",
        "options": [
          { "codeItem": 1, "value": "Bus6", "label": "Bus" },
          { "codeItem": 2, "value": "Train", "label": "Train", "requiresPrecision": true },
          { "codeItem": 3, "value": "Voiture", "label": "Voiture" },
          { "codeItem": 6, "value": "Aucun", "label": "Aucun", "exclusive": true }
        ],
        "required": true,
        "output_cond": "value.length > 0",
        "isSubQuestion": false
      },
      {
        "id": "q9",
        "title": "Q9bis.",
        "type": "single_choice",
        "label": "Fr√©quence d‚Äôutilisation du transport en commun",
        "options": [
          { "codeItem": 1, "label": "Tous les jours1", "requiresSubQst": {
            "value": true,
            "subQst_id": "q10"
          } },
          { "codeItem": 2, "label": "Quelques fois par semaine2", "requiresPrecision": true }
        ],
        "placeholder": "",
        "help_text": "S√©lectionnez la fr√©quence la plus proche de votre utilisation",
        "required": true,
        "isSubQuestion": true
      },
      {
        "id": "q10",
        "title": "Q10bis.",
        "type": "autocomplete",
        "label": "Votre commune de r√©sidence",
        "table": "communes",
        "columns": [
          { "name": "commune", "displayInList": true, "displayInInput": true, "saveInDB": true },
          { "name": "cp", "displayInList": true, "displayInInput": true, "saveInDB": true },
          { "name": "_id", "displayInList": false, "displayInInput": false, "saveInDB": true }
        ],
        "placeholder": "Tapez pour rechercher votre commune",
        "help_text": "Commencez √† taper et s√©lectionnez la commune correspondante",
        "input_cond": "",
        "output_cond": "value !== null",
        "required": true,
        "isSubQuestion": true
      },{
        "id": "q30",
        "type": "accordion",
        "title": "Q30.",
        "label": "D√©tails sur vos moyens de transport",
        "page": 8,
        "required": true,
        "redirection": "q2",
      
        "sections": [
          {
            "id": "acc_bus",
            "title": "Bus",
            "required": false,
      
            "questions": [
              {
                "id": "q30_1",
                "type": "single_choice",
                "label": "Utilisez-vous le bus ?",
                "required": true,
                "options": [
                  { "codeItem": 1, "label": "Oui" },
                  { "codeItem": 2, "label": "Non" }
                ],
      
                "subQuestions": [
                  {
                    "if": {
                      "operator": "EQUALS",
                      "field": "codeItem",
                      "value": 1
                    },
                    "questions": [
                      {
                        "id": "q30_1a",
                        "type": "spinner",
                        "label": "Fr√©quence d‚Äôutilisation",
                        "options": ["Tous les jours", "Hebdomadaire", "Rarement"],
                        "required": true
                      }
                    ]
                  }
                ]
              }
            ]
          },
      
          {
            "id": "acc_train",
            "title": "Train",
            "required": true,
      
            "questions": [
              {
                "id": "q30_2",
                "type": "text",
                "label": "Pourquoi utilisez-vous le train ?",
                "required": true
              }
            ]
          }
        ]
      }
      
    ]
  }
  


  

  // response.routes.js
import express from 'express';
import SurveyService from '../services/SurveyService.js';
import ResponseService from '../services/ResponseService.js';
import ResponseNormalizer from '../services/ResponseNormalizer.js';
import RotationQueueUtils from '../services/RotationQueueUtils.js';
import NavigationRuleService from '../services/NavigationRuleService.js';

const router = express.Router();

router.post('/:surveyId/run', async (req, res) => {
  const { surveyId } = req.params;
  const action = req.body.action || 'next';
  const userId = 'anonymous';

  const survey = SurveyService.loadSurvey(surveyId);

  /* =========================
     1Ô∏è‚É£ Init session
  ========================= */
  if (!req.session.answers) req.session.answers = {};
  if (!req.session.rotationQueueDone) req.session.rotationQueueDone = {};

  /* =========================
     2Ô∏è‚É£ Cr√©er document r√©ponse
  ========================= */
  if (!req.session.responseId) {
    const response = await ResponseService.createSurveyDocument(
      surveyId,
      userId,
      {}
    );
    req.session.responseId = response._id;
  }

  const responseId = req.session.responseId;

  /* =========================
     3Ô∏è‚É£ D√©terminer question courante
  ========================= */
  let currentStep;
  let isInRotation = false;

  // Si on a une rotation en cours
  if (req.session.rotationQueue?.length) {
    currentStep = req.session.rotationQueue[0].step;
    isInRotation = true;
    console.log('üéØ En rotation:', currentStep.id);
  } 
  // Navigation normale
  else if (req.session.currentStepId) {
    currentStep = survey.steps.find(s => s.id === req.session.currentStepId);
  } 
  // D√©marrage du questionnaire
  else {
    currentStep = survey.steps
      .filter(s => s.page !== undefined)
      .sort((a, b) => a.page - b.page)[0];
    req.session.currentStepId = currentStep.id;
  }

  const currentPage = currentStep.page;

  /* =========================
     4Ô∏è‚É£ Questions √† afficher
  ========================= */
  let stepsOnPage = [];
  if (isInRotation) {
    stepsOnPage = [currentStep];
  } else {
    stepsOnPage = survey.steps.filter(s => s.page === currentPage);
  }

  /* =========================
     5Ô∏è‚É£ Sauvegarde r√©ponses (AVANT navigation)
  ========================= */
  if (action === 'next' && stepsOnPage.length > 0) {
    console.log(`üíæ Sauvegarde pour ${stepsOnPage.length} √©tape(s) sur cette page`);
    
    for (const step of stepsOnPage) {
      let rawValue = req.body[step.id];
      
      // Log pour d√©bogage
      console.log(`üìù Traitement step ${step.id}:`, {
        type: step.type,
        rawValue: rawValue,
        bodyKeys: Object.keys(req.body)
      });

      // Gestion sp√©ciale pour les types complexes
      if (['grid', 'accordion', 'single_choice', 'multiple_choice'].includes(step.type)) {
        rawValue = req.body;
        console.log(`üîß Type ${step.type} - rawValue:`, rawValue[step.id]);
      }

      if (rawValue !== undefined) {
        // Normaliser la r√©ponse
        const normalized = ResponseNormalizer.normalize(step, rawValue);
        console.log(`‚úÖ Normalis√© pour ${step.id}:`, normalized);
        
        // Sauvegarder dans la DB
        await ResponseService.addAnswer(responseId, normalized);
        
        // Sauvegarder dans la session
        if (!step.isSubQuestion) {
          let mainValue;
          
          switch (step.type) {
            case 'multiple_choice':
              mainValue = req.body[step.id] || [];
              break;
            case 'single_choice':
              mainValue = req.body[step.id] || '';
              break;
            default:
              mainValue = rawValue;
          }
          
          req.session.answers[step.id] = mainValue;
          console.log(`üíæ Session sauvegard√©e ${step.id}:`, mainValue);
        }
      } else {
        console.log(`‚ö†Ô∏è Pas de valeur pour ${step.id}`);
      }
    }
  }

/* =========================
     6Ô∏è‚É£ Initialiser la rotation
========================= */
if (action === 'next' && !req.session.rotationQueue) {
  for (const step of survey.steps) {
    if (step.repeatFor && 
        req.session.answers[step.repeatFor] && 
        !req.session.rotationQueueDone[step.repeatFor]) {
      
      req.session.rotationQueue = RotationQueueUtils.generateRotationQueue(
        survey,
        step.repeatFor,
        req.session.answers
      );
      
      req.session.rotationQueueDone[step.repeatFor] = true;
      
      // TR√àS IMPORTANT: Sortir IMM√âDIATEMENT apr√®s cr√©ation de la rotation
      // La premi√®re √©tape sera affich√©e au prochain GET
      req.session.currentStepId = req.session.rotationQueue[0].step.id;
      console.log(`‚ú® Rotation cr√©√©e, redirection vers: ${req.session.currentStepId}`);
      return res.redirect(`/survey/${surveyId}/run`);
    }
  }
}

  /* =========================
     7Ô∏è‚É£ D√©terminer la prochaine √©tape
  ========================= */
  let nextStepId;
  let nextStep;

  if (req.session.rotationQueue?.length) {
    console.log(`üîÑ Rotation en cours (${req.session.rotationQueue.length} restants)`);
    
    if (action === 'next') {
      // Supprimer l'√©tape actuelle (d√©j√† trait√©e)
      const processed = req.session.rotationQueue.shift();
      console.log(`‚úÖ √âtape trait√©e: ${processed?.step?.id}`);
      
      // V√©rifier s'il reste des √©tapes
      if (req.session.rotationQueue.length > 0) {
        // Passer √† la prochaine √©tape de rotation
        nextStep = req.session.rotationQueue[0].step;
        nextStepId = nextStep.id;
        console.log(`‚û°Ô∏è Prochaine √©tape rotation: ${nextStepId}`);
      } else {
        // Fin de la rotation
        console.log('üèÅ Fin de la rotation');
        delete req.session.rotationQueue;
        
        // Trouver la question parente
        const parentStep = survey.steps.find(s => s.id === processed?.parent);
        if (parentStep?.redirection) {
          nextStepId = parentStep.redirection;
          console.log(`üìç Redirection apr√®s rotation: ${nextStepId}`);
        } else {
          // Navigation normale depuis la derni√®re √©tape
          nextStepId = NavigationRuleService.resolve(
            processed?.step || currentStep,
            req.session.answers[processed?.step?.id || currentStep.id],
            survey.steps
          );
        }
      }
    } else {
      // Pour "prev", rester sur la m√™me √©tape
      nextStepId = currentStep.id;
    }
  } else {
    // Navigation normale
    nextStepId = NavigationRuleService.resolve(
      currentStep,
      req.session.answers[currentStep.id],
      survey.steps
    );
    console.log(`‚û°Ô∏è Navigation normale: ${nextStepId}`);
  }

  /* =========================
     8Ô∏è‚É£ FIN questionnaire
  ========================= */
  if (!nextStepId || nextStepId === 'FIN') {
    console.log('üèÅ Fin du questionnaire');
    req.session.destroy();
    return res.redirect(`/survey/${surveyId}/end`);
  }

  /* =========================
     9Ô∏è‚É£ Aller √† la prochaine question
  ========================= */
  req.session.currentStepId = nextStepId;
  console.log(`üìç Prochaine √©tape d√©finie: ${nextStepId}`);
  console.log('--- Session actuelle ---');
  console.log('- answers:', req.session.answers);
  console.log('- rotationQueue:', req.session.rotationQueue?.length || 0);
  console.log('------------------------');

  return res.redirect(`/survey/${surveyId}/run`);
});

export default router;



// response.routes.js
import express from 'express';
import ResponseNormalizer from '../services/ResponseNormalizer.js';
import SurveyService from '../services/SurveyService.js';
import RotationQueueUtils from '../services/RotationQueueUtils.js';
import ResponseService from '../services/ResponseService.js';

const router = express.Router();

router.post('/:surveyId/run', async (req, res) => {
  const { surveyId } = req.params;
  const action = req.body.action || 'next';
  const userId = 'anonymous';

  const survey = SurveyService.loadSurvey(surveyId);

  if (!req.session.answers) req.session.answers = {};
  if (!req.session.pageNumber) req.session.pageNumber = 1;
  if (!req.session.rotationQueueDone) req.session.rotationQueueDone = {};
  
  let pageNumber = req.session.pageNumber;
  /* ======================================================
     1 Cr√©er le document r√©ponse (UNE SEULE FOIS)
     ====================================================== */
  if (!req.session.responseId) {
    const response = await ResponseService.createSurveyDocument(
      surveyId,
      userId,
      {}
    );
    req.session.responseId = response._id;
    console.log('üìÑ Document cr√©√©:', response._id);
  }

  const responseId = req.session.responseId;


  /* ======================================================
     2 D√©terminer le STEP COURANT
     ====================================================== */
     let stepsOnPage = [];

     if (req.session.rotationQueue && req.session.rotationQueue.length > 0) {
       // rotation : ne traiter que la premi√®re question
       stepsOnPage = [req.session.rotationQueue[0]];
     } else {
       // page normale : toutes les steps sur cette page
       stepsOnPage = survey.steps.filter(step => step.page === pageNumber);
     }

  /* ======================================================
     3 Sauvegarder la r√©ponse si elle existe
     ====================================================== */
     if (action === 'next') {
     for (const stepWrapper of stepsOnPage)  {
      const stepToNormalize = stepWrapper.step || stepWrapper;
    let rawValue = req.body[stepToNormalize.id];

    if (['accordion','grid','single_choice','multiple_choice'].includes(stepToNormalize.type)) {
      rawValue = req.body;
    }

    if (rawValue !== undefined) {
   console.log("rawvalue",rawValue)
      const normalized = ResponseNormalizer.normalize(stepToNormalize, rawValue,stepWrapper.optionIndex);
      console.log("normlize response",normalized)

      await ResponseService.addAnswer(responseId, normalized);

      // M√©moriser r√©ponse principale (pour rotation)
      if (!stepToNormalize.isSubQuestion) {
         // On stocke seulement la valeur principale pour la rotation
  const mainValue = (stepToNormalize.type === 'multiple_choice')
  ? req.body[stepToNormalize.id] // array des codes s√©lectionn√©s
  : rawValue;
        req.session.answers[stepToNormalize.id] = mainValue;
      }

      console.log(` R√©ponse sauvegard√©e: ${stepToNormalize.id}_${stepWrapper.optionIndex || ''}`);
    }
  }
}
/* ===============================================
         4 Consommer UNE question de rotation
         =============================================== */
         if (req.session.rotationQueue && req.session.rotationQueue.length > 0) {
          req.session.rotationQueue.shift();
        }
  /* ======================================================
     5Ô∏è‚É£ Initialiser la rotation (UNE SEULE FOIS)
     ====================================================== */
  if (!req.session.rotationQueue) {
    // Pour chaque step qui peut avoir une rotation
    for (const step of survey.steps) {
      if (step.repeatFor && req.session.answers[step.repeatFor] && !req.session.rotationQueueDone[step.repeatFor]) {
        req.session.rotationQueue = RotationQueueUtils.generateRotationQueue(
          survey,
          step.repeatFor,
          req.session.answers
        );
        req.session.rotationQueueDone[step.repeatFor] = true; // rotation g√©n√©r√©e
      //  console.log(' Rotation g√©n√©r√©e pour', step.repeatFor, req.session.rotationQueue.map(s => s.id));
        break; // ne g√©n√©rer qu‚Äôune rotation √† la fois
      }
    }
  }
  /* ======================================================
     6Ô∏è‚É£ Fin de rotation ‚Üí pagination normale
     ====================================================== */
     if (req.session.rotationQueue && req.session.rotationQueue.length === 0) {
      delete req.session.rotationQueue;
    }
    

  /* ======================================================
     7Ô∏è‚É£ Pagination normale (hors rotation)
     ====================================================== */
  if (!req.session.rotationQueue) {
    const pages = [...new Set(survey.steps.map(s => s.page))].sort((a, b) => a - b);
    const index = pages.indexOf(pageNumber);

    pageNumber = action === 'prev'
      ? pages[Math.max(0, index - 1)]
      : pages[index + 1];

    req.session.pageNumber = pageNumber;
  }

  /* ======================================================
     8Ô∏è‚É£ Fin du questionnaire
     ====================================================== */
  if (!pageNumber) {
    req.session.destroy();
    return res.redirect(`/survey/${surveyId}/end`);
  }

  /* ======================================================
     9Ô∏è‚É£ Afficher la question suivante
     ====================================================== */
  res.redirect(`/survey/${surveyId}/run`);
});

export default router;




// // response.routes.js
// import express from 'express';
// import SurveyService from '../services/SurveyService.js';
// import ResponseService from '../services/ResponseService.js';
// import ResponseNormalizer from '../services/ResponseNormalizer.js';
// import RotationQueueUtils from '../services/RotationQueueUtils.js';
// import NavigationRuleService from '../services/NavigationRuleService.js';

// const router = express.Router();

// router.post('/:surveyId/run', async (req, res) => {
//   const { surveyId } = req.params;
//   const action = req.body.action || 'next';
//   const userId = 'anonymous';

//   const survey = SurveyService.loadSurvey(surveyId);

//   /* =========================
//      1Ô∏è‚É£ Init session
//   ========================= */
//   if (!req.session.answers) req.session.answers = {};
//   if (!req.session.rotationQueueDone) req.session.rotationQueueDone = {};

//   /* =========================
//      2Ô∏è‚É£ Cr√©er document r√©ponse
//   ========================= */
//   if (!req.session.responseId) {
//     const response = await ResponseService.createSurveyDocument(
//       surveyId,
//       userId,
//       {}
//     );
//     req.session.responseId = response._id;
//   }

//   const responseId = req.session.responseId;

//   /* =========================
//      3Ô∏è‚É£ D√©terminer question pivot
//   ========================= */
//   let currentStep;

//   // Rotation prioritaire
//   if (req.session.rotationQueue?.length) {
//     currentStep = req.session.rotationQueue[0].step;
//  console.log('current rotation', req.session.rotationQueue[0]);
//   } 
//   // Navigation normale
//   else if (req.session.currentStepId) {
//     currentStep = survey.steps.find(s => s.id === req.session.currentStepId);
//   } 
//   // D√©marrage du questionnaire
//   else {
//     currentStep = survey.steps
//       .filter(s => s.page !== undefined)
//       .sort((a, b) => a.page - b.page)[0];

//     req.session.currentStepId = currentStep.id;
//   }

//   // Si on est en rotation, supprimer l'√©tape trait√©e seulement maintenant
// // if (req.session.rotationQueue?.length) {
// //   req.session.rotationQueue.shift();
// //   if (req.session.rotationQueue.length === 0) {
// //     delete req.session.rotationQueue;
// //   }
// // }

//   const currentPage = currentStep.page;

//   /* =========================
//      4Ô∏è‚É£ Questions √† afficher
//   ========================= */
//   let stepsOnPage = [];

//   if (req.session.rotationQueue?.length) {
//     stepsOnPage = [currentStep];
//   } else {
//     stepsOnPage = survey.steps.filter(s => s.page === currentPage);
//   }

//   /* =========================
//      5Ô∏è‚É£ Sauvegarde r√©ponses
//   ========================= */
//   if (action === 'next') {
//     for (const step of stepsOnPage) {
//       let rawValue = req.body[step.id];

//       if (['grid', 'accordion', 'single_choice', 'multiple_choice'].includes(step.type)) {
//         rawValue = req.body;
//       }

//       if (rawValue !== undefined) {
//         const normalized = ResponseNormalizer.normalize(step, rawValue);
//         await ResponseService.addAnswer(responseId, normalized);

// if (!step.isSubQuestion) {
//   let mainValue;

//   switch (step.type) {
//     case 'multiple_choice':
//       mainValue = req.body[step.id]; // array des codeItem s√©lectionn√©s
//       break;
//     case 'single_choice':
//       //  Prend la valeur sp√©cifique de la question, pas tout le formulaire
//       mainValue = req.body[step.id]; 
//       break;
//     default:
//       mainValue = rawValue;
//   }

//   req.session.answers[step.id] = mainValue;
// }

//       }
//     }
//   }

  
//   /* =========================
//      7Ô∏è‚É£ Init rotation (1 fois)
//   ========================= */
//   if (!req.session.rotationQueue) {
//     for (const step of survey.steps) {
//       if (
//         step.repeatFor &&
//         req.session.answers[step.repeatFor] &&
//         !req.session.rotationQueueDone[step.repeatFor]
//       ) {
//         req.session.rotationQueue =
//           RotationQueueUtils.generateRotationQueue(
//             survey,
//             step.repeatFor,
//             req.session.answers
//           );

//         req.session.rotationQueueDone[step.repeatFor] = true;
//         break;
//       }
//     }
//   }

//   /* =========================
//      8Ô∏è‚É£ R√©soudre navigation
//   ========================= */
//   console.log("currentStep",currentStep)
//   console.log("req.session.answers[currentStep.id]" ,req.session.answers , req.session.answers[currentStep.id])
  
//   let nextStepId;

// if (req.session.rotationQueue?.length) {
//   // On prend la prochaine √©tape dans la rotation
//     const currentRotation = req.session.rotationQueue[0];
//   nextStepId = currentRotation.step.id;
//    // Si la rotation est termin√©e
//     if (action === 'next') {
//     // Supprimer la sous-question trait√©e seulement apr√®s avoir choisi nextStepId
//     req.session.rotationQueue.shift();

//     // Si la rotation est maintenant termin√©e
//     if (!req.session.rotationQueue || req.session.rotationQueue.length === 0) {
//       delete req.session.rotationQueue;
//       // Aller √† la question parent et r√©cup√©rer sa redirection
//       const parentStep = survey.steps.find(
//         s => s.id === currentRotation.parent
//       );

//       if (parentStep) {
//         // Si parent a navigation sp√©cifique, on l'utilise
//         nextStepId = parentStep.redirection || 'FIN';
//       }
//     }
//   }
// } else {
//   // Navigation conditionnelle normale
//     nextStepId =  NavigationRuleService.resolve(
//     currentStep,
//     req.session.answers[currentStep.id],
//     survey.steps
//   );
//   console.log("nextstep",nextStepId)
// }
 
//   /* =========================
//      9Ô∏è‚É£ FIN questionnaire
//   ========================= */
//   if (!nextStepId || nextStepId === 'FIN') {
//     req.session.destroy();
//     return res.redirect(`/survey/${surveyId}/end`);
//   }

//   /* =========================
//      üîü Aller √† la prochaine question
//   ========================= */
//   req.session.currentStepId = nextStepId;

//   return res.redirect(`/survey/${surveyId}/run`);
// });

// export default router;
