<form id="surveyForm" method="POST" action="/survey/{{survey.id}}/run">
  {{#steps}}
    <div class="question-block" style="margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px;">
      {{#title}}<h4>{{title}} {{label}}</h4>{{/title}}
      
      {{#description}}<p>{{description}}</p>{{/description}}
      
      {{#type_text}}{{> questions/text}}{{/type_text}}
      {{#type_single_choice}}{{> questions/single_choice}}{{/type_single_choice}}
      {{#type_multiple_choice}}{{> questions/multiple_choice}}{{/type_multiple_choice}}
      {{#type_spinner}}{{> questions/spinner}}{{/type_spinner}}
      {{#type_autocomplete}}{{> questions/autocomplete}}{{/type_autocomplete}}
      {{#type_grid}}{{> questions/grid}}{{/type_grid}}
      {{#type_accordion}}{{> questions/accordion}}{{/type_accordion}}
    </div>
  {{/steps}}

  
  <div style="display: flex; justify-content: space-between; margin-top: 20px;">
    <button type="submit" name="_action" value="prev" {{#isFirstPage}}disabled{{/isFirstPage}} 
    style="background-color:#6c757d; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-size:16px; opacity: {{#isFirstPage}}0.5{{/isFirstPage}}{{^isFirstPage}}1{{/isFirstPage}};
  ">
      Précédent
    </button>

    <button type="submit" name="_action" value="next"  style="background-color:#007bff; color:white; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; font-size:16px;">
      Suivant
    </button>
  </div>
</form>


<script type="module">
import ToastService from '/assets/js/ToastService.js';
function serializeForm(form) {
  const obj = {};
  const elements = form.querySelectorAll('input, select, textarea');

  elements.forEach(el => {
    let name = el.name;
    if (!name) return;

    // retirer les crochets [] pour les tableaux
    const isArray = name.endsWith('[]');
    if (isArray) name = name.slice(0, -2);

    if (el.type === 'checkbox') {
      if (!obj[name]) obj[name] = [];
      if (el.checked) obj[name].push(el.value);
    } else if (el.type === 'radio') {
      if (el.checked) obj[name] = el.value;
    } else {
      obj[name] = el.value;
    }
  });

  return obj;
}


const form = document.getElementById('surveyForm');

form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const button = document.activeElement;
  const action = button?.value || 'next';

  const answers = serializeForm(form);
  answers._action = action;
  console.log("answers",answers)

 try {
    const res = await fetch(form.action, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(answers)
     
    });

    const data = await res.json();
console.log("data",data)

    if (data.success === false) {
  if (data.messages?.length) {
     ToastService.show('Veuillez compléter les champs obligatoires', {
      type: 'error',
      duration: 4000
    });
  } 
  return;
}

alert('test')
    if (data.finished) {
      window.location.href = data.redirectUrl;
      return;
    }

    window.location.reload();

  } catch (err) {
    ToastService.show('Erreur serveur', { type: 'error' });
    console.error(err);
  }
});
</script>
