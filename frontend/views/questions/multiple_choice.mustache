{{#options}}
  <label>
    <input type="checkbox" 
    name="{{id}}[]" 
    value="{{codeItem}}"
    data-has-sub="{{hasSubQuestions}}"
    {{#isSelected}}checked{{/isSelected}}
    data-requires-precision="{{requiresPrecision}}"
    data-exclusive="{{exclusive}}">
    {{label}}
  </label>

  <input type="text"
   name="precision_{{id}}_{{codeItem}}"
   class="precision-input" 
   value="{{precisionValue}}"
   style="{{#showPrecision}}display:inline-block;{{/showPrecision}}{{^showPrecision}}display:none;{{/showPrecision}}"
   placeholder="Précisez..." />

  {{#hasSubQuestions}}
   <div class="sub-questions"
    data-parent="{{codeItem}}"
    style="{{^showSubQuestions}}display:none;{{/showSubQuestions}}">
  
  {{#subQuestions}}
    {{> partials/accQuestion}}
  {{/subQuestions}}

</div>
{{/hasSubQuestions}}

{{/options}}

<script>
document.addEventListener('DOMContentLoaded', function() {

  const checkboxes = document.querySelectorAll(
    'input[type=checkbox][name="{{id}}[]"]'
    );

  checkboxes.forEach(cb => {
    cb.addEventListener('change', function() {

      /* ************** précision************/
      const precisionInput = document.querySelector(
        `input[name=precision_{{id}}_${this.value}]`
        );

 if (precisionInput) {
        precisionInput.style.display =
          this.checked && this.dataset.requiresPrecision === 'true'
            ? 'inline-block'
            : 'none';
      }
      
      /* ************** sub question************/
      const subQ = this.closest('form').querySelector(
  `.sub-questions[data-parent="${this.value}"]`
);

if (subQ) {
  subQ.style.display = this.checked ? 'block' : 'none';
}
      // *****************************Gestion exclusif
      if(this.dataset.exclusive==='true' && this.checked){
        checkboxes.forEach(other => {
          if(other !== this){
            other.checked = false;
            other.disabled = true;

            //cacher précision
            document.querySelector(
              `input[name=precision_{{id}}_${other.value}]`).style.display='none';
          
                      // cacher sous-questions
            const otherSub = document.querySelector(
              `.sub-questions[data-parent="${other.value}"]`
            );
            if (otherSub) otherSub.style.display = 'none';

          }
        });

      } else if(this.dataset.exclusive!=='true'){
        checkboxes.forEach(excl => {
          if(excl.dataset.exclusive==='true'){
            excl.checked = false;
            excl.disabled = false;
            document.querySelector(`input[name=precision_{{id}}_${excl.value}]`).style.display='none';
          }
        });
      } else {
        checkboxes.forEach(other => {
          if(other.dataset.exclusive==='true') return;
          other.disabled = false;
        });
      }
    });
if (!cb.dataset.requiresPrecision) return;

    // afficher le champ de précision si déjà sélectionné
    if(cb.checked && cb.dataset.requiresPrecision==='true'){
      document.querySelector(`input[name=precision_{{id}}_${cb.value}]`).style.display='inline-block';
    }
    
    if (cb.checked) {
  const subQ = document.querySelector(
    `.sub-questions[data-parent="${cb.value}"]`
  );
  if (subQ) subQ.style.display = 'block';
}

  });
});
</script>
